
<dom-module id="taaabs-trace-display-icons">

  <link rel="import" type="css" href="../../bower_components/samotracesjs/dist/samotraces.css"/>

  <template>
    <paper-button raised on-click="refreshButtonClick">
      <iron-icon icon="refresh"></iron-icon>
      Refresh
    </paper-button>
    <paper-checkbox id="checkbox-observ-obsels" on-change="observChangeHandler">Obsels Observation</paper-checkbox>
  </template>

  <script>
    /* global Polymer, Samotraces */

    Polymer({
      is: 'taaabs-trace-display-icons',
      properties: {
        timewindow: {
          type: Object,
          reflectToAttribute: true,
          notify: true,
          observer: 'timeChanged'
        },
        trace: {
          type: Object,
          notify: true,
          observer: 'traceChanged'
        },
        obselselector: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        },
        options: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        },
        selected: {
          type: Number,
          observer: '_selectedChanged'
        },
        pageNum: {
          type: Number,
        }
      },
      traceChanged: function() {
        this.attachWidget();
      },
      timeChanged: function() {
        this.attachWidget();
      },
      attached: function() {
        this.attachWidget();
      },
      observChangeHandler: function() {
        var checkboxObservObsels = this.$$('#checkbox-observ-obsels');
        var clickHandler = ''; // no click handler by default
        if (checkboxObservObsels && checkboxObservObsels.checked) {
          // if the checkbox is checked, we will bind to the clickhandler
          clickHandler = this.handleClick.bind(this);
        }
        var obsClass = '.Samotraces-obsel';
        var obselsNodeList = (this.shadowRoot) ? this.shadowRoot.querySelectorAll(obsClass) : this.querySelectorAll(obsClass);
        // forall obsel Node, attach a click handler
        for (var i = 0; i < obselsNodeList.length; i++) {
          var obsel = obselsNodeList[i];
          obsel.onclick = clickHandler;
        }
      },
      handleClick: function(event) {
        // TODO replace __data__ by a $(event.target).data() after fixing it in Samotraces
        var obsel = event.target.__data__;
        this.obselselector.select(obsel);
      },
      attachWidget: function() {
        if (!! this.trace && !! this.timewindow && this.pageNum === this.selected) {
          var options = {
              url: function() {
                  return 'images/teapot.png';
              },
              width: 34,
              height: 40,
          };
          // Create widget
          if (!this.widgetObject) {
            var element = document.createElement('div');
            element.setAttribute('id', 'widget');
            Polymer.dom(this.root).appendChild(element);
            this.widgetObject = new Samotraces.Ui.Widgets.TraceDisplayIcons(this.$$('#widget'), this.trace, this.timewindow, options);
          }
        }
      },
      refreshButtonClick: function() {
        var coeff = Math.pow(0.8, 1);
        this.timewindow.zoom(coeff);
      },
      _selectedChanged: function(newSelectedValue) {
        if (newSelectedValue === this.pageNum) {
          setTimeout(this.attachWidget.bind(this), 1000);
        }
        else {
          if (!! this.$$('#widget')) {
            Polymer.dom(this.root).removeChild(this.$$('#widget'));
            this.set('widgetObject', null);
          }
        }
      }
    });
  </script>
</dom-module>
