<link rel="import" href="../../behaviors/taaabs-lazy-loading.html">

<!--
-->

<dom-module id="taaabs-trace-display-icons">

  <link rel="import" type="css" href="../../bower_components/samotracesjs/dist/samotraces.css"/>

  <template>
    <paper-spinner active="{{loading}}"></paper-spinner>
    <paper-checkbox id="checkbox-observ-obsels" on-change="observChangeHandler">Obsels Observation</paper-checkbox>
  </template>

  <script>
    /* global Polymer, Samotraces, TaaabsBehaviors */

    /*
      `<taaabs-trace-display-icons>` is an element that is displaying a Trace

      The `<taaabs-trace-display-icons>` element exposes the following attributes
      - timeWindow
      - trace
      - obselSelector
      - options

      Inherited from `TaaabsBehaviors.LazyLoading`
      - selected
      - pageNum
    */
    Polymer({
      is: 'taaabs-trace-display-icons',
      behaviors: [
        TaaabsBehaviors.LazyLoading
      ],
      properties: {
        timeWindow: {
          type: Object,
          reflectToAttribute: true,
          notify: true,
          observer: 'timeChanged'
        },
        trace: {
          type: Object,
          notify: true,
          observer: 'traceChanged'
        },
        obselSelector: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        },
        options: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        },
        loading: {
          type: Boolean
        }
      },
      ready: function () {
        this.WidgetConstructor = Samotraces.Ui.Widgets.TraceDisplayIcons;
        this.options = { // TODO remove this and use a behavior for options
            url: function() {
                return 'images/teapot.png';
            }
        };

        this._attachWidget(this.WidgetConstructor, [this.trace, this.timeWindow, this.options]);
      },
      traceChanged: function() {
        this.set('loading', true);
        this._detachWidget();
        this._attachWidget(this.WidgetConstructor, [this.trace, this.timeWindow, this.options]);

        // disable the paper-spinner when the trace is fully loaded:
        this.trace.on('trace:updateCompleted', (function() {
          this.set('loading', false);
        }).bind(this));
      },
      timeChanged: function() {
        this._attachWidget(this.WidgetConstructor, [this.trace, this.timeWindow, this.options]);
      },
      observChangeHandler: function() {
        var checkboxObservObsels = this.$$('#checkbox-observ-obsels');
        var clickHandler = ''; // no click handler by default
        if (checkboxObservObsels && checkboxObservObsels.checked) {
          // if the checkbox is checked, we will bind to the clickhandler
          clickHandler = this.handleClick.bind(this);
        }
        var obsClass = '.Samotraces-obsel';
        var obselsNodeList = (this.shadowRoot) ? this.shadowRoot.querySelectorAll(obsClass) : this.querySelectorAll(obsClass);
        // forall obsel Node, attach a click handler
        for (var i = 0; i < obselsNodeList.length; i++) {
          var obsel = obselsNodeList[i];
          obsel.onclick = clickHandler;
        }
      },
      handleClick: function(event) {
        // TODO replace __data__ by a $(event.target).data() after fixing it in Samotraces
        var obsel = event.target.__data__;
        this.obselSelector.select(obsel);
      },
    });
  </script>
</dom-module>
