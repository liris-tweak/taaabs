
<dom-module id="taaabs-trace-display-icons">

  <link rel="import" type="css" href="../../bower_components/samotracesjs/dist/samotraces.css"/>

  <template>
    <div id="widget"></div>
  </template>

  <script>
    /* global Polymer, Samotraces */

    Polymer({
      is: 'taaabs-trace-display-icons',
      properties: {
        timewindow: {
          type: Object,
          reflectToAttribute: true,
          notify: true,
          observer: 'timeChanged'
        },
        trace: {
          type: Object,
          notify: true,
          observer: 'traceChanged'
        },
        obselselector: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        },
        options: {
          type: Object,
          reflectToAttribute: true,
          notify: true
        }
      },
      traceChanged: function() {
        this.attachWidget();
      },
      timeChanged: function() {
        this.attachWidget();
      },
      attached: function() {
        this.attachWidget();
      },
      observObsels: function() {
        var obsClass = '.Samotraces-obsel';
        var obselsNodeList = (this.shadowRoot) ? this.shadowRoot.querySelectorAll(obsClass) : this.querySelectorAll(obsClass);
        // forall obsel Node, attach a click handler
        for (var i = 0; i < obselsNodeList.length; i++) {
          var obsel = obselsNodeList[i];
          obsel.onclick = this.handleClick.bind(this);
        }
      },
      handleClick: function(event) {
        var obsel = event.target.__data__;
        this.obselselector.select(obsel);
      },
      attachWidget: function() {
        if (!! this.trace && !! this.timewindow) {
          var widgetElement = this.$$('#widget');
          var options = {
              url: function() {
                  return 'images/teapot.png';
              },
              width: 34,
              height: 40,
          };
          // Create widget
          this.widgetObject = new Samotraces.Ui.Widgets.TraceDisplayIcons(widgetElement, this.trace, this.timewindow, options);
          this.widgetObject.trace.on('trace:create_obsel', (function () {
            this.observObsels(); // TODO very bad complexity, if we import 100 obsels, we do ~100^2 operations, need to add a button
          }).bind(this));
        }
      }
    });
  </script>
</dom-module>
