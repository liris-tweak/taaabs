
<!-- for JSONLD -->
<script src="//cdnjs.cloudflare.com/ajax/libs/jsonld/0.3.15/jsonld.js"></script>

<!-- http://underscorejs.org/
for functional filtering, uniq... -->
<script src="../../bower_components/underscore/underscore-min.js"></script>

<dom-module id="taaabs-trace-to-model">
  <style>
    :host {
      display: block;
    }
  </style>
  <template>
    <div>{{model}}</div>
  </template>

  <script>
    (function () {
      /* global Polymer, _, jsonld */

      Polymer({
        is: 'taaabs-trace-to-model',
        properties: {
          model: {
            type: String,
            notify: true
          },
          trace: {
            type: Object,
            observer: '_traceChanged',
          }
        },
        _traceChanged: function(trace) {
          // Start to fetch the server to get obsels
          trace.list_obsels(); // jshint ignore:line

          trace.on('trace:updateCompleted', (function() {
            // We now have all obsels, we can get the obsel list
            var obsels = trace.obsel_list; // jshint ignore:line

            // Define the proper JSONLD context
            var context = 'http://liris.cnrs.fr/silex/2011/ktbs-jsonld-context';

            // Parse informations about trace uri, traceName
            var parsedTraceInformations = this._traceUriParser(trace.get_uri()); // jshint ignore:line
            var baseUrl = parsedTraceInformations.baseUrl;
            var traceName = parsedTraceInformations.traceName;
            this.baseUrl = baseUrl;

            // Create a virtual Uri for the generated model to be able tu PUT it to the KTBS if needed
            var modelUrl = baseUrl + traceName + '-' + 'model';
            this.modelUrl = modelUrl;
            var doc = {
              '@context': 'http://liris.cnrs.fr/silex/2011/ktbs-jsonld-context',
              '@graph': [{
                '@id': modelUrl,
                '@type': 'TraceModel',
                'inBase': './',
                'hasUnit': 'millisecond'
              }]
            };

            // Keep only useful information for the model
            var obselInformations = _.map(obsels, function(obsel) {
              return {
                'obselType': obsel.type,
                'obselAttributes': _.map(Object.keys(obsel.attributes),
                    function(obselAttribute) {
                  return {
                    'obselAttribute': obselAttribute,
                    'hasAttributeDatatype': 'xsd:string' // TODO HARDCODED datatype
                    // TODO label ??
                  };
                })
              };
            });
            // Remove duplicates
            obselInformations = _.uniq(obselInformations, function(e) {
              return e.obselType;
            });

            _.each(obselInformations, function(obselInformation) {
              doc['@graph'].push({
                '@id': '#' + obselInformation.obselType,
                '@type': 'ObselType'
              });
              _.each(obselInformation.obselAttributes,
                  function(obselAttributeObject) {
                doc['@graph'].push({
                  '@id': '#' + obselAttributeObject.obselAttribute,
                  '@type': 'AttributeType',
                  'hasAttributeObselType': '#' + obselInformation.obselType,
                  'hasAttributeDatatype': obselAttributeObject.hasAttributeDatatype
                  // TODO label ??
                });
              });
            });

            var that = this;

            // This is not technically required
            // We use this to do JSON-LD validation:
            jsonld.promises.compact(doc, context).then(function(compact) {
              // console.log(JSON.stringify(compact, null, 2));
              that.model = JSON.stringify(compact, null, 2);

              setTimeout(function() {
                var request = that._deleteModel();
                request.then(function() {
                  // OK
                  console.log('OK after DELETE');

                  // in any preceding case, we can POST
                  that._postModel().then(function() {
                    console.log('OK after POST');
                  });
                }).catch(function() {
                  // do PUT instead
                  console.log('cannot delete ?');

                  // in any preceding case, we can POST
                  that._postModel().then(function() {
                    console.log('OK after POST');
                  });
                });
              }, 1000);
            });
          }).bind(this));
        },
        _requestFactory: function(args) {
          if (!!args.method && !!args.contentType && !!args.url && !!args.body) {
            var ironAjax = document.createElement('iron-ajax');
            ironAjax.url = args.url;
            ironAjax.method = args.method;
            ironAjax.contentType = args.contentType;
            ironAjax.body = args.body;
            return ironAjax.generateRequest().completes;
          } else {
            return new Promise(function (resolve, reject) {
              reject('Missing args');
            });
          }
        },
        _deleteModel: function() {
          var req = this._requestFactory({
            'url': this.modelUrl,
            'method': 'DELETE',
            'contentType': 'application/ld+json',
            'body': this.model,
          });
          return req;
        },
        _postModel: function() {
          var req = this._requestFactory({
            'url': this.baseUrl,
            'method': 'POST',
            'contentType': 'application/ld+json',
            'body': this.model,
          });
          return req;
        },
        _traceUriParser: function(traceUri) {
          var traceUriArray = traceUri.split('/');
          var baseUrl = '';
          var traceName = '';

          if (traceUriArray.slice(-1)[0] === '') {
            // http://localhost:8001/base1/t01/ (with '/' suffix)
            baseUrl = traceUriArray.slice(0, traceUriArray.length - 2);
            traceName = traceUriArray[traceUriArray.length - 2];
          } else {
            // http://localhost:8001/base1/t01 (without '/' suffix)
            baseUrl = traceUriArray.slice(0, traceUriArray.length - 1);
            traceName = traceUriArray[traceUriArray.length - 1];
          }
          return {
            'baseUrl': baseUrl.join('/') + '/',
            'traceName': traceName
          };
        },
      });
    })();
  </script>

</dom-module>
